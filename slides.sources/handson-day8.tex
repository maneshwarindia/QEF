\documentclass[landscape]{foils}
\usepackage[pdftex]{color}
\usepackage{url}
\usepackage[pdftex]{graphicx}
\usepackage{eso-pic}
\usepackage[top=2cm, bottom=2cm, outer=0cm, inner=0cm]{geometry}
\usepackage{listings}
\usepackage{amsmath}

\input{aliases}

\begin{document}
\AddToShipoutPictureBG*{\includegraphics[width=\paperwidth,height=\paperheight]{figs/qe2021-background-4x3.png}}

\blue
%\includegraphics[width=1.0\textwidth]{figs/QE2019-logo.pdf}
~\\
\vspace*{4cm}
\MyLogo{~}
\vspace{5em}
\begin{center}
  {\burgundy\LARGE\bf QE-2021: Hands-on session -- Day-8}\\[2em]
  {\burgundy\LARGE (Ab Initio Molecular Dynamics)}
  ~\\[1.5em]
  %\large Pietro Delugas, Anton Kokalj, Paolo Giannozzi, Xiang Mei Duan,\\
  %Matic Pober\v{z}nik, Unmesh Mondal, Matej Hu\v{s}, Yaning Cui
\end{center}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\Head{QE-2021: Hands-on session -- Day-8}
\MyLogo{\burgundy {\bf QE-2021}: MaX School on Advanced Materials and Molecular Modelling}
\rightheader{\hspace{-0.8cm}\includegraphics[width=4.5cm]{figs/QE.png}}
In this tutorial we will see how to use the code \prog{cp.x}. We will:
\begin{enumerate}
\item start a BOMD simulation with conjugate gradient minimization of the DFT energy
\item run a Car-Parrinello molecular dynamics simulation (CPMD)
\item run the Nose-Hoover thermostat
\item run a longer microcanonical ensemble simulation
\item view the trajectory and calculate $g(r)$ and mean square displacement from the simulation trajectory
\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\head{BOMD: small recap}
\begin{itemize}
\item trajectory: time series of position, velocities and in general many quantities that depend on time. It is written on many files by the code
\item Born Oppenheimer approximation: nuclei are classical
\item adiabaticity: electrons are always in their ground state at every timestep
\item Newton equation of motion for the nuclei
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{Start of the simulation}
We are going to integrate the following equation of motions:
\begin{equation}
	M_I\ddot R_I = -\nabla_{R_I} E_{DFT}(\{R_J\}_{J\in\text{nuclei}})
\end{equation}
That will be discretized according to a Verlet scheme. We have to select all the parameters that are needed to evaulate the forces via the Hellman-Feynman theorem.
That means selecting plane wave cutoff, pseudopotentials, etc.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\head{BOMD cp.x's input file}
\begin{minipage}{0.5\textwidth}
\card{
 \&control \\
    title = 'Water 8 molecules',\\
    calculation = 'cp',\\
    restart\_mode = 'from\_scratch',\\
    ndr = 50,\\
    ndw = 50,\\
    nstep  = 100,\\
    iprint = 10,\\
    isave  = 1000,\\
    ! tprnfor = .TRUE.,\\
    dt    = 5.0d0,\\
    prefix = 'h2o',\\
    pseudo\_dir='../pseudo',\\
    outdir='./',\\
 /\\
}
\end{minipage}
\begin{minipage}{0.5\textwidth}
\card{
 \&system\\
    ibrav=1, celldm(1)=13.00000\\
    nat = 24,\\
    ntyp = 2,\\
    ecutwfc = 50.0,\\
 /\\
 \&electrons\\
    emass = 50.d0,\\
    emass\_cutoff = 2.5d0,\\
    electron\_dynamics = 'cg',\\
 /\\
 \&ions\\
    ion\_dynamics = 'verlet',\\
    !ion\_velocities = 'zero',\\
    ion\_velocities = 'random',\\
    tempw=600.d0\\
	/\\
}
\end{minipage}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\head{BOMD cp.x's input file}
\begin{minipage}{0.5\textwidth}
\card{
 \&cell\\
    cell\_dynamics = 'none',
 /\\
ATOMIC\_SPECIES\\
 O  16.0d0   O\_ONCV\_PBE-1.2.upf\\
 H  1.0079d0 H\_ONCV\_PBE-1.2.upf\\
ATOMIC\_POSITIONS (bohr)\\
O 0.48E+01 0.37E+01 0.37E+01\\
H 0.40E+01 0.59E+01 0.35E+01\\
.\\
.\\
.\\
}
put here all the atomic positions\\
\end{minipage}
\begin{minipage}{0.5\textwidth}
then, at the end of the input file\\
\card{
AUTOPILOT\\
on\_step=10 : dt = 20.d0\\
on\_step=90 : dt = 5.d0\\
ENDRULES\\
}
This will change the dt parameter during the simulation.
\end{minipage}\\

\hrule The documentation for the AUTOPILOT module can be found at
\url{https://gitlab.com/QEF/q-e/-/blob/develop/CPV/Doc/README.AUTOPILOT}
It is possible to modify some parameters on the fly while the simulation is running by placing a special file called \file{pilot.mb} inside the folder where you are running the simulation

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{BOMD run and tips on initial state}
Ok, now try to run the input file on the cluster!\\
\code{remote\_mpirun cp.x -in cp.water8.1-bomd.in}\\
While it runs you can have a look on how it was created the input file. I took a water molecule, rotate it randomly and then apply other rotation matrixes of some symmetry groups to get a filled cell. A different option could be starting from a crystal, that is usually simpler for structures like say NaCl.

If you want to open the jupyter notebook file, you have to go inside the \code{Day-8/misc} folder, open a terminal and install some python code (if not already done) with \code{pip install jupyter numpy scipy k3d}, then you can open the notebook with \code{~/.local/bin/jupyter notebook} and play with it. Learning python is beyond the scope of this tutorial, but I think is good to know that those tools exists.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{See what was produced}

explain output file and output columns

\head{See the trajectory}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{CPMD start}

Now we will modify the input file of the BOMD to do the verlet integration of the Car-Parrinello lagrangian. Few modifications are necessary:
\begin{itemize}
    \item set \verb\calculation = 'restart'\ to start from a previously stopped calculation
    \item set \verb\ndw = 51\ (increase by one the number of the folder where the code will write the restart file)
    \item set \verb\nstep = 1000\ if you want to run for 1000 steps
    \item set \verb\electron_dynamics = 'verlet'\ to set the verlet algorithm to integrate the Car-Parrinello equation of morion
    \item set \verb\ion_velocities = 'default'\ to read the velocity from the specified restart file
    \item remove the \verb\AUTOPILOT\ card
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{Output produced }

explain kinetic energy

constant of motion

force issue

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{Nose-Hoover thermostat}


\begin{itemize}
    \item set the number of steps to 1000 with \verb\nstep = 1000\
    \item increase by one \verb\ndr\ and \verb\ndw\
    \item set the Nose-Hoover thermostat (namelist \verb\IONS\):
    \begin{itemize}
        \item set nose: \verb\ion_temperature = 'nose'\
        \item temperature: \verb\tempw = 600.d0\
        \item nose frequency: \verb\fnosep = 5.d0\ 
        \item number of thermostat in the NH chain: \verb\nhpcl = 3\ 
    \end{itemize}
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{See what happened}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{CG step}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{final NVE simulation}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{look at the trajectory}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{$g(r)$ plot}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{mean square displacement plot}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\head{force comparison between CP and BO}


\end{document}
